name: Build Custom Talos

on:
  workflow_dispatch:
    inputs:
      talos_version:
        description: "Talos version (e.g. v1.12.4)"
        required: true
  workflow_call:
    inputs:
      talos_version:
        type: string
        required: true

permissions:
  contents: write
  packages: write

env:
  LOCAL_REGISTRY: localhost:5005
  USERNAME: tsuguya
  ISCSI_TOOLS_IMAGE: ghcr.io/siderolabs/iscsi-tools:v0.2.0

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          swap-storage: false

      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Start local registry
        run: docker run -d -p 5005:5000 --name registry registry:2

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Talos
        uses: actions/checkout@v4
        with:
          repository: siderolabs/talos
          ref: ${{ inputs.talos_version }}
          path: talos

      - name: Extract PKGS version
        id: pkgs
        run: |
          PKGS_VERSION=$(grep '^PKGS ' talos/Makefile | awk '{print $3}')
          if [[ ! "$PKGS_VERSION" =~ ^v[0-9] ]]; then
            echo "::error::Failed to extract PKGS version: $PKGS_VERSION"
            exit 1
          fi
          PKGS_COMMIT=$(echo "$PKGS_VERSION" | sed 's/.*-g//')
          echo "version=$PKGS_VERSION" >> "$GITHUB_OUTPUT"
          echo "commit=$PKGS_COMMIT" >> "$GITHUB_OUTPUT"
          echo "PKGS version: $PKGS_VERSION (commit: $PKGS_COMMIT)"

      - name: Checkout pkgs
        run: |
          git clone https://github.com/siderolabs/pkgs.git pkgs
          cd pkgs
          git checkout ${{ steps.pkgs.outputs.commit }}

      - name: Apply UFS kernel config
        run: bash scripts/apply-kernel-config.sh kernel/ufs.config pkgs/kernel/build/config-amd64

      - name: Resolve kernel config dependencies
        working-directory: pkgs
        run: make kernel-olddefconfig USERNAME=${{ env.USERNAME }} PLATFORM=linux/amd64

      - name: Build kernel
        working-directory: pkgs
        run: |
          make kernel \
            PLATFORM=linux/amd64 \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }}

      - name: Get kernel tag
        id: kernel
        run: |
          TAGS_JSON=$(curl -sf http://${{ env.LOCAL_REGISTRY }}/v2/${{ env.USERNAME }}/kernel/tags/list)
          TAG=$(echo "$TAGS_JSON" | jq -r '.tags[0]')
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "::error::Failed to get kernel tag: $TAGS_JSON"
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "image=${{ env.LOCAL_REGISTRY }}/${{ env.USERNAME }}/kernel:$TAG" >> "$GITHUB_OUTPUT"
          echo "Kernel image: ${{ env.LOCAL_REGISTRY }}/${{ env.USERNAME }}/kernel:$TAG"

      - name: Build installer-base
        working-directory: talos
        run: |
          make installer-base \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=${{ steps.kernel.outputs.image }}

      - name: Build and push installer to GHCR
        working-directory: talos
        run: |
          make installer \
            PUSH=true \
            REGISTRY=ghcr.io \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=${{ steps.kernel.outputs.image }} \
            PLATFORM=linux/amd64 \
            INSTALLER_ARCH=targetarch

      - name: Build imager
        working-directory: talos
        run: |
          make imager \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=${{ steps.kernel.outputs.image }} \
            PLATFORM=linux/amd64 \
            INSTALLER_ARCH=targetarch

      - name: Build ISO
        working-directory: talos
        run: |
          make image-iso \
            IMAGER_ARGS="--arch amd64 --system-extension-image ${{ env.ISCSI_TOOLS_IMAGE }}" \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.talos_version }}
          name: Talos ${{ inputs.talos_version }}
          body: |
            Custom Talos build with UFS support for Minisforum S100.

            - Talos: ${{ inputs.talos_version }}
            - PKGS: ${{ steps.pkgs.outputs.version }}
            - System extensions: ${{ env.ISCSI_TOOLS_IMAGE }}
          files: talos/_out/metal-amd64.iso
