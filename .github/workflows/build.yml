name: Build Custom Talos

on:
  workflow_dispatch:
    inputs:
      talos_version:
        description: "Talos version (e.g. v1.12.4)"
        required: true
  workflow_call:
    inputs:
      talos_version:
        type: string
        required: true

permissions:
  contents: write
  packages: write

env:
  LOCAL_REGISTRY: localhost:5005
  USERNAME: tsuguya
  ISCSI_TOOLS_IMAGE: ghcr.io/siderolabs/iscsi-tools:v0.2.0

jobs:
  kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if kernel already exists
        id: check
        run: |
          if docker manifest inspect ghcr.io/${{ env.USERNAME }}/kernel:${{ inputs.talos_version }} > /dev/null 2>&1; then
            echo "Kernel image already exists — skipping build"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Kernel image not found — will build"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Free disk space
        if: steps.check.outputs.exists != 'true'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          swap-storage: false

      - name: Checkout this repository
        if: steps.check.outputs.exists != 'true'
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists != 'true'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Start local registry
        if: steps.check.outputs.exists != 'true'
        run: docker run -d -p 5005:5000 --name registry registry:2

      - name: Checkout Talos
        if: steps.check.outputs.exists != 'true'
        uses: actions/checkout@v6
        with:
          repository: siderolabs/talos
          ref: ${{ inputs.talos_version }}
          path: talos

      - name: Extract PKGS version
        if: steps.check.outputs.exists != 'true'
        id: pkgs
        run: |
          PKGS_VERSION=$(grep '^PKGS ' talos/Makefile | awk '{print $3}')
          if [[ ! "$PKGS_VERSION" =~ ^v[0-9] ]]; then
            echo "::error::Failed to extract PKGS version: $PKGS_VERSION"
            exit 1
          fi
          PKGS_COMMIT=$(echo "$PKGS_VERSION" | sed 's/.*-g//')
          echo "version=$PKGS_VERSION" >> "$GITHUB_OUTPUT"
          echo "commit=$PKGS_COMMIT" >> "$GITHUB_OUTPUT"

      - name: Checkout pkgs
        if: steps.check.outputs.exists != 'true'
        run: |
          git clone https://github.com/siderolabs/pkgs.git pkgs
          cd pkgs
          git checkout ${{ steps.pkgs.outputs.commit }}

      - name: Apply UFS kernel config
        if: steps.check.outputs.exists != 'true'
        run: bash scripts/apply-kernel-config.sh kernel/ufs.config pkgs/kernel/build/config-amd64

      - name: Resolve kernel config dependencies
        if: steps.check.outputs.exists != 'true'
        working-directory: pkgs
        run: make kernel-olddefconfig USERNAME=${{ env.USERNAME }} PLATFORM=linux/amd64

      - name: Build kernel
        if: steps.check.outputs.exists != 'true'
        working-directory: pkgs
        run: |
          make kernel \
            PLATFORM=linux/amd64 \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }}

      - name: Push kernel to GHCR
        if: steps.check.outputs.exists != 'true'
        run: |
          CRANE_VERSION=$(curl -sf https://api.github.com/repos/google/go-containerregistry/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar xzf - crane
          sudo mv crane /usr/local/bin/
          echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u "${{ github.actor }}" --password-stdin

          TAG=$(curl -sf http://${{ env.LOCAL_REGISTRY }}/v2/${{ env.USERNAME }}/kernel/tags/list | jq -r '.tags[0]')
          echo "Local kernel tag: $TAG"

          crane copy --insecure \
            ${{ env.LOCAL_REGISTRY }}/${{ env.USERNAME }}/kernel:${TAG} \
            ghcr.io/${{ env.USERNAME }}/kernel:${{ inputs.talos_version }}

  installer:
    needs: kernel
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          swap-storage: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Start local registry
        run: docker run -d -p 5005:5000 --name registry registry:2

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install crane
        run: |
          CRANE_VERSION=$(curl -sf https://api.github.com/repos/google/go-containerregistry/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar xzf - crane
          sudo mv crane /usr/local/bin/
          echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Checkout Talos
        uses: actions/checkout@v6
        with:
          repository: siderolabs/talos
          ref: ${{ inputs.talos_version }}
          path: talos

      - name: Extract PKGS version
        id: pkgs
        run: |
          PKGS_VERSION=$(grep '^PKGS ' talos/Makefile | awk '{print $3}')
          echo "version=$PKGS_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build installer-base
        working-directory: talos
        run: |
          make installer-base \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=ghcr.io/${{ env.USERNAME }}/kernel:${{ inputs.talos_version }}

      - name: Build imager
        working-directory: talos
        run: |
          make imager \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=ghcr.io/${{ env.USERNAME }}/kernel:${{ inputs.talos_version }} \
            PLATFORM=linux/amd64 \
            INSTALLER_ARCH=targetarch

      - name: Build installer
        working-directory: talos
        run: |
          make installer \
            PUSH=true \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }} \
            PKG_KERNEL=ghcr.io/${{ env.USERNAME }}/kernel:${{ inputs.talos_version }} \
            PLATFORM=linux/amd64 \
            INSTALLER_ARCH=targetarch

      - name: Push installer to GHCR
        run: |
          crane copy --insecure \
            ${{ env.LOCAL_REGISTRY }}/${{ env.USERNAME }}/installer:${{ inputs.talos_version }} \
            ghcr.io/${{ env.USERNAME }}/installer:${{ inputs.talos_version }}

      - name: Build ISO
        working-directory: talos
        run: |
          make image-iso \
            IMAGER_ARGS="--arch amd64 --system-extension-image ${{ env.ISCSI_TOOLS_IMAGE }}" \
            REGISTRY=${{ env.LOCAL_REGISTRY }} \
            USERNAME=${{ env.USERNAME }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.talos_version }}
          name: Talos ${{ inputs.talos_version }}
          body: |
            Custom Talos build with x86 UFS storage support.

            - Talos: ${{ inputs.talos_version }}
            - PKGS: ${{ steps.pkgs.outputs.version }}
            - System extensions: ${{ env.ISCSI_TOOLS_IMAGE }}
          files: talos/_out/metal-amd64.iso
